//
//  TextFieldTableViewCell.swift
//  iOSTakeOpenTest
//
//  Created by Oladipupo Oluwatobi on 09/06/2020.
//  Copyright Â© 2020 Oladipupo Oluwatobi. All rights reserved.
//

import UIKit

class TextFieldTableViewCell: UITableViewCell {
    
    @IBOutlet weak var textField: DesignableTextField!
    @IBOutlet weak var headerLabel: UILabel!
    @IBOutlet weak var errorLabel: UILabel!
    private var datePicker: UIDatePicker?
    var  charaterLimit: Int?
    var data: Elements! {
        didSet {
            datePicker = UIDatePicker()
            datePicker?.datePickerMode = .date
            datePicker?.addTarget(self, action: #selector(dateChanged(datePicker:)), for: .valueChanged)
            setUpTextField()
            let tapGesture = UITapGestureRecognizer(target: self, action: #selector(viewTapped(gestureRegonizer:)))
            self.textField.delegate = self
            self.addGestureRecognizer(tapGesture)
            if let elements = data {
                if elements.type == "datetime" {
                    textField.inputView = datePicker
                }
                
                textField.placeholder  = elements.label
                if elements.type == "formattednumeric" {
                    textField.keyboardType = .numberPad
                    
                }
                if elements.unique_id == "text_1" {
                    textField.leftImage = #imageLiteral(resourceName: "user")
                    textField.leftPadding = 10
                    textField.valueType = .fullName
                    textField.keyboardType = .default
                }
                
                if elements.unique_id == "formattednumeric_1" {
                    textField.leftImage = #imageLiteral(resourceName: "user")
                    textField.leftPadding = 10
                    self.textField.maxLength = 11
                }
                
                if elements.unique_id == "text_2" {
                    textField.leftImage = #imageLiteral(resourceName: "email")
                    textField.leftPadding = 10
                    textField.keyboardType = .emailAddress
                }
                
                if elements.unique_id == "datetime_1" {
                    textField.leftImage = #imageLiteral(resourceName: "calenda")
                    textField.leftPadding = 10
                }
                
                if let name = elements.label {
                    if name == "Date of Birth" {
                        if elements.isMandatory == true {
                            headerLabel.text =   "Select Your \(name)*"
                        }else{
                            headerLabel.text =   "Select Your \(name)"
                        }
                    }else {
                        if elements.isMandatory == true {
                            headerLabel.text =   "Enter Your \(name)*"
                        }else{
                            headerLabel.text =   "Enter Your \(name)"
                        }
                    }
                    
                    
                }
                
                
                
            }
            
        }
    }
    
    @objc func viewTapped(gestureRegonizer: UITapGestureRecognizer) {
        self.endEditing(true)
        
    }
    
    
    @objc func dateChanged(datePicker: UIDatePicker) {
        let dateFormatter = DateFormatter()
        dateFormatter.dateFormat = "MM/dd/yyyy"
        textField.text = dateFormatter.string(from: datePicker.date)
    }
    
    
    
}

extension TextFieldTableViewCell: UITextFieldDelegate {
    
    
    private func setUpTextField()  {
        textField.bind { (text) in
            if self.data.label == "Email address" {
                self.errorLabel.alpha = 1
                let isValid = self.isValidEmail(text)
                self.errorLabel.text = isValid ? "" : "Email is not valid"
            }
            
        }
    }
    
    private func isValidEmail(_ email: String) -> Bool {
        let emailRegEx = "[A-Z0-9a-z._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,64}"
        
        let emailPred = NSPredicate(format:"SELF MATCHES %@", emailRegEx)
        return emailPred.evaluate(with: email)
    }
    
    func textFieldShouldReturn(_ textField: UITextField) -> Bool {
        textField.resignFirstResponder()
        return true
    }
    
    func textField(_ textField: UITextField, shouldChangeCharactersIn range: NSRange, replacementString string: String) -> Bool {
        
        // Verify all the conditions
        if let sdcTextField = textField as? DesignableTextField {
            return sdcTextField.verifyFields(shouldChangeCharactersIn: range, replacementString: string)
        }
        return false
    }
    
}
