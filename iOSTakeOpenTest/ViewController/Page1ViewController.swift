//
//  ViewController.swift
//  iOSTakeOpenTest
//
//  Created by Oladipupo Oluwatobi on 09/06/2020.
//  Copyright Â© 2020 Oladipupo Oluwatobi. All rights reserved.
//

import UIKit

class Page1ViewController: BaseViewController {
    @IBOutlet weak var tableView: UITableView!
    @IBOutlet weak var nextButton: UIButton!
    @IBOutlet weak var headerTitleLabel: UILabel!
    @IBOutlet weak var buttomConstrain: NSLayoutConstraint!
    @IBOutlet weak var buttonButtomConstrain: NSLayoutConstraint!
    var isTrue = Bool()
    var name  = Bool()
    var phone = Bool()
    var email = Bool()
    var dob = Bool()
    var contrain = Bool()
    
    var firstSection = [Sections]()
    private var arrayOfCells: [TextFieldTableViewCell] = []
    private var cell: TextFieldTableViewCell!
    private var isValidated =  Bool()
    override func viewDidLoad() {
        super.viewDidLoad()
        // Do any additional setup after loading the view.
        addScrollViewListener(constraint: buttomConstrain)
        tableView.dataSource = self
        if let data = DataLoader().userData?.pages?[0].sections {
            firstSection = data
            headerTitleLabel.text = firstSection[0].label
        }
        tableView.separatorStyle = .none
        tableView.reloadData()
        nextButton.layer.cornerRadius = 7
        nextButton.isEnabled = false
        nextButton.alpha = 0.7
        
        view.addTapGesture {
            self.view.endEditing(true)
            self.istoValidate()
            //self.expandScrollView()
            
            
            
        }
        
    }
    func keybodywillDisappare () {
        for i in 0..<self.arrayOfCells.count {
            if self.arrayOfCells[i].data.label == "Email address" {
                
            }
            if  self.arrayOfCells[i].data.label == "Phone Number"  {
                self.expandScrollView()
            }
            if  self.arrayOfCells[i].data.label ==  "Your fullname" {
                self.expandScrollView()
            }
            if  self.arrayOfCells[i].data.label ==  "Date of Birth" {
                
            }
          
        }
    }
    func parameterBuilder () {
        let builder = FormBuilder.Builder()
        for i in 0..<arrayOfCells.count {
            
            if arrayOfCells[i].data.label == "Email address" {
                if let email = arrayOfCells[i].textField.text{
                    builder.email = email
                }
                
            }
            if arrayOfCells[i].data.label == "Your fullname" {
                if let fullname = arrayOfCells[i].textField.text{
                    builder.fullname = fullname
                }
                
            }
            
            if arrayOfCells[i].data.label == "Phone Number" {
                if let phonenumber = arrayOfCells[i].textField.text{
                    builder.phoneNumber = phonenumber
                }
                
            }
            
            if arrayOfCells[i].data.label == "Date of Birth" {
                if let dob = arrayOfCells[i].textField.text{
                    builder.dob = dob
                }
                
            }
        }
        
        let _ = StoryBoardsID.boardMain.navigationProvider.requestNavigation(to: ViewControllerID.Page2ViewController.rawValue, from: self, requestData: builder)
    }
    func istoValidate() {
        for i in 0..<arrayOfCells.count {
            if arrayOfCells[i].data.isMandatory == true && arrayOfCells[i].textField.hasText != true {
                arrayOfCells[i].errorLabel.alpha = 1
                self.arrayOfCells[i].errorLabel.textWithAnimation(text: "This field is required" , duration: 0.5)
            }else {
                
                if arrayOfCells[i].data.label ==  "Email address" {
                    arrayOfCells[i].errorLabel.alpha = 1
                    if let email = arrayOfCells[i].textField.text{
                        let isValid = arrayOfCells[i].isValidEmail(email)
                        let error = isValid ? "" : "Email is not valid"
                        self.arrayOfCells[i].errorLabel.textWithAnimation(text: error , duration: 0.5)
                    }
                    
                }
                
                if arrayOfCells[i].data.label ==  "Phone Number"{
                    arrayOfCells[i].errorLabel.alpha = 1
                    
                    let checkNumber = arrayOfCells[i].numberCheck()
                    let error = checkNumber ? "" : "Must contain exactly 11 charaters"
                    self.arrayOfCells[i].errorLabel.textWithAnimation(text: error , duration: 0.5)
                    
                }
                
                
            }
            if arrayOfCells[i].data.label ==  "Email address" {
                print("This is the email ",arrayOfCells[i].validate)
                if arrayOfCells[i].validate == true {
                    email = true
                }else {
                    email = false
                }
                
            }
            if arrayOfCells[i].data.label ==  "Phone Number"{
                if arrayOfCells[i].validateOther == true {
                    phone = true
                }else{
                    phone = false
                }
                
            }
            
            if  arrayOfCells[i].data.label ==  "Your fullname" {
                print("This is the name ",arrayOfCells[i].nameValidator)
                if arrayOfCells[i].nameValidator == true {
                    name = true
                }else {
                    name = false
                }
                
            }
            
            if  arrayOfCells[i].data.label ==  "Date of Birth" {
                print("This is the dob",arrayOfCells[i].dobValidator)
                if arrayOfCells[i].dobValidator == true {
                    dob = true
                }else {
                    dob = false
                }
                
            }
            if phone == true && name == true && email == true && dob == true  {
                isTrue = true
                
            }else {
                isTrue = false
            }
            print("This actual value",isTrue)
            if isTrue == true {
                nextButton.alpha = 1
                self.nextButton.isEnabled = true
            }else{
                
                nextButton.alpha = 0.7
                self.nextButton.isEnabled = false
            }
            
            
        }
    }
    
    
    @IBAction func btnStart(_ sender: UIButton) {
        parameterBuilder()
        
    }
    
    
}

extension Page1ViewController: UITableViewDataSource {
    
    func numberOfSections(in tableView: UITableView) -> Int {
        return firstSection.count
    }
    
    func tableView(_ tableView: UITableView, didEndEditingRowAt indexPath: IndexPath?) {
        arrayOfCells[(indexPath?.row)!].textField.text = cell.textField.text
    }
    
    func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return firstSection[section].elements!.count
    }
    
    func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let cell = tableView.dequeueReusableCell(withIdentifier: "textfieldelement", for: indexPath) as? TextFieldTableViewCell
        
        cell?.selectionStyle = .none
        cell?.addTapGesture {
                  self.view.endEditing(true)
                  self.istoValidate()
                 self.expandScrollView()
              }
        
        cell?.data = firstSection[indexPath.section].elements?[indexPath.row]
        arrayOfCells += [cell!]
        
      
        
        return cell!
    }
    
    
}

